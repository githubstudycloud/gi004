# Spring Boot 4.0 四层架构图

## 一、四层架构总览

```
╔═══════════════════════════════════════════════════════════════════════════════════════╗
║                          Spring Boot 4.0 四层架构                                      ║
╠═══════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                       ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐  ║
║  │                           表现层 (Presentation Layer)                            │  ║
║  │                                                                                 │  ║
║  │   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  │  ║
║  │   │ REST 控制器   │  │  WebSocket    │  │   GraphQL     │  │    视图       │  │  ║
║  │   │ @RestController│ │   Handler     │  │   Controller  │  │  Thymeleaf   │  │  ║
║  │   └───────┬───────┘  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘  │  ║
║  │           │                  │                  │                  │          │  ║
║  │   • HTTP 请求/响应处理                                                         │  ║
║  │   • JSON 序列化/反序列化 (Jackson 3)                                           │  ║
║  │   • 请求验证 (@Valid)                                                          │  ║
║  │   • API 版本控制 (version 属性)                                               │  ║
║  │   • 身份认证入口                                                              │  ║
║  └─────────────────────────────────────────────────────────────────────────────────┘  ║
║                                          │                                            ║
║                                          ▼                                            ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐  ║
║  │                            业务层 (Business Layer)                              │  ║
║  │                                                                                 │  ║
║  │   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  │  ║
║  │   │   Service     │  │   Facade      │  │   Domain      │  │   Event       │  │  ║
║  │   │   @Service    │  │   Pattern     │  │   Model       │  │   Handler     │  │  ║
║  │   └───────┬───────┘  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘  │  ║
║  │           │                  │                  │                  │          │  ║
║  │   • 核心业务逻辑                                                              │  ║
║  │   • 事务管理 (@Transactional)                                                 │  ║
║  │   • 业务验证                                                                  │  ║
║  │   • 授权检查 (@PreAuthorize)                                                  │  ║
║  │   • 领域事件发布                                                              │  ║
║  └─────────────────────────────────────────────────────────────────────────────────┘  ║
║                                          │                                            ║
║                                          ▼                                            ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐  ║
║  │                           持久层 (Persistence Layer)                            │  ║
║  │                                                                                 │  ║
║  │   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  │  ║
║  │   │  Repository   │  │    DAO        │  │   Cache       │  │   Search      │  │  ║
║  │   │ @Repository   │  │   Pattern     │  │   Manager     │  │   Index       │  │  ║
║  │   └───────┬───────┘  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘  │  ║
║  │           │                  │                  │                  │          │  ║
║  │   • 数据访问抽象                                                              │  ║
║  │   • ORM 映射 (Hibernate / JPA)                                               │  ║
║  │   • 查询构建 (Query DSL / Criteria)                                          │  ║
║  │   • 缓存策略                                                                  │  ║
║  │   • 分页排序                                                                  │  ║
║  └─────────────────────────────────────────────────────────────────────────────────┘  ║
║                                          │                                            ║
║                                          ▼                                            ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐  ║
║  │                           数据库层 (Database Layer)                             │  ║
║  │                                                                                 │  ║
║  │   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  │  ║
║  │   │  关系型数据库  │  │  NoSQL 数据库  │  │   缓存服务    │  │   搜索引擎    │  │  ║
║  │   │ PostgreSQL   │  │   MongoDB     │  │    Redis      │  │Elasticsearch │  │  ║
║  │   │ MySQL/Oracle │  │   Cassandra   │  │    Caffeine   │  │   OpenSearch │  │  ║
║  │   └───────────────┘  └───────────────┘  └───────────────┘  └───────────────┘  │  ║
║  │                                                                                 │  ║
║  └─────────────────────────────────────────────────────────────────────────────────┘  ║
║                                                                                       ║
╚═══════════════════════════════════════════════════════════════════════════════════════╝
```

## 二、请求处理流程

```
╔════════════════════════════════════════════════════════════════════════════════════════╗
║                              HTTP 请求处理流程                                          ║
╠════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                        ║
║      Client                                                                            ║
║        │                                                                               ║
║        │  HTTP Request                                                                 ║
║        ▼                                                                               ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐  ║
║  │                           Servlet Container (Tomcat/Jetty)                       │  ║
║  └─────────────────────────────────────────────────────────────────────────────────┘  ║
║        │                                                                               ║
║        ▼                                                                               ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐  ║
║  │                              Security Filter Chain                               │  ║
║  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐    │  ║
║  │  │   CORS     │→│   CSRF     │→│   Auth     │→│  Session   │→│Authorization│    │  ║
║  │  │  Filter    │ │  Filter    │ │  Filter    │ │  Filter    │ │  Filter    │    │  ║
║  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘ └────────────┘    │  ║
║  └─────────────────────────────────────────────────────────────────────────────────┘  ║
║        │                                                                               ║
║        ▼                                                                               ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐  ║
║  │                              DispatcherServlet                                   │  ║
║  │                                                                                  │  ║
║  │    ┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐      │  ║
║  │    │  HandlerMapping  │ ──► │  HandlerAdapter  │ ──► │  ViewResolver    │      │  ║
║  │    └──────────────────┘     └──────────────────┘     └──────────────────┘      │  ║
║  └─────────────────────────────────────────────────────────────────────────────────┘  ║
║        │                                                                               ║
║        ▼                                                                               ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐  ║
║  │                              @RestController                                     │  ║
║  │                                                                                  │  ║
║  │    ┌─────────────────────────────────────────────────────────────────────────┐  │  ║
║  │    │  @GetMapping("/api/users", version = "2")                               │  │  ║
║  │    │  public List<User> getUsers() {                                         │  │  ║
║  │    │      return userService.findAll();                                      │  │  ║
║  │    │  }                                                                      │  │  ║
║  │    └─────────────────────────────────────────────────────────────────────────┘  │  ║
║  └─────────────────────────────────────────────────────────────────────────────────┘  ║
║        │                                                                               ║
║        ▼                                                                               ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐  ║
║  │                                @Service                                          │  ║
║  │                                                                                  │  ║
║  │    ┌─────────────────────────────────────────────────────────────────────────┐  │  ║
║  │    │  @Transactional                                                         │  │  ║
║  │    │  public List<User> findAll() {                                          │  │  ║
║  │    │      return userRepository.findAll();                                   │  │  ║
║  │    │  }                                                                      │  │  ║
║  │    └─────────────────────────────────────────────────────────────────────────┘  │  ║
║  └─────────────────────────────────────────────────────────────────────────────────┘  ║
║        │                                                                               ║
║        ▼                                                                               ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐  ║
║  │                               @Repository                                        │  ║
║  │                                                                                  │  ║
║  │    ┌─────────────────────────────────────────────────────────────────────────┐  │  ║
║  │    │  public interface UserRepository extends JpaRepository<User, Long> {    │  │  ║
║  │    │      List<User> findByStatus(Status status);                            │  │  ║
║  │    │  }                                                                      │  │  ║
║  │    └─────────────────────────────────────────────────────────────────────────┘  │  ║
║  └─────────────────────────────────────────────────────────────────────────────────┘  ║
║        │                                                                               ║
║        ▼                                                                               ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐  ║
║  │                                Database                                          │  ║
║  │                            PostgreSQL / MySQL                                    │  ║
║  └─────────────────────────────────────────────────────────────────────────────────┘  ║
║                                                                                        ║
╚════════════════════════════════════════════════════════════════════════════════════════╝
```

## 三、组件依赖关系图

```
╔════════════════════════════════════════════════════════════════════════════════════════╗
║                            Spring Boot 4.0 组件依赖关系                                ║
╠════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                        ║
║                          ┌─────────────────────────────┐                              ║
║                          │     Your Application        │                              ║
║                          │   @SpringBootApplication    │                              ║
║                          └─────────────┬───────────────┘                              ║
║                                        │                                              ║
║               ┌────────────────────────┼────────────────────────┐                    ║
║               │                        │                        │                    ║
║               ▼                        ▼                        ▼                    ║
║   ┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐            ║
║   │ spring-boot-      │   │ spring-boot-      │   │ spring-boot-      │            ║
║   │ starter-webmvc    │   │ starter-data-jpa  │   │ starter-security  │            ║
║   └─────────┬─────────┘   └─────────┬─────────┘   └─────────┬─────────┘            ║
║             │                       │                       │                        ║
║             ▼                       ▼                       ▼                        ║
║   ┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐            ║
║   │ spring-boot-      │   │ spring-boot-      │   │ spring-boot-      │            ║
║   │ webmvc            │   │ data-jpa          │   │ security          │            ║
║   └─────────┬─────────┘   └─────────┬─────────┘   └─────────┬─────────┘            ║
║             │                       │                       │                        ║
║             │                       │                       │                        ║
║             ▼                       ▼                       ▼                        ║
║   ┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐            ║
║   │ spring-boot-      │   │ spring-boot-      │   │ spring-boot-      │            ║
║   │ autoconfigure     │   │ autoconfigure     │   │ autoconfigure     │            ║
║   │ (webmvc module)   │   │ (data-jpa module) │   │ (security module) │            ║
║   └─────────┬─────────┘   └─────────┬─────────┘   └─────────┬─────────┘            ║
║             │                       │                       │                        ║
║             └───────────────────────┼───────────────────────┘                        ║
║                                     │                                                ║
║                                     ▼                                                ║
║                         ┌───────────────────────┐                                    ║
║                         │     spring-boot       │                                    ║
║                         │        (core)         │                                    ║
║                         └───────────┬───────────┘                                    ║
║                                     │                                                ║
║                                     ▼                                                ║
║                         ┌───────────────────────┐                                    ║
║                         │   Spring Framework    │                                    ║
║                         │        7.0            │                                    ║
║                         └───────────┬───────────┘                                    ║
║                                     │                                                ║
║           ┌─────────────────────────┼─────────────────────────┐                     ║
║           │                         │                         │                     ║
║           ▼                         ▼                         ▼                     ║
║   ┌───────────────┐       ┌───────────────┐       ┌───────────────┐                ║
║   │  spring-core  │       │ spring-beans  │       │spring-context │                ║
║   └───────────────┘       └───────────────┘       └───────────────┘                ║
║                                     │                                                ║
║                                     ▼                                                ║
║                         ┌───────────────────────┐                                    ║
║                         │     Jakarta EE 11     │                                    ║
║                         │   JVM (Java 17-25)    │                                    ║
║                         └───────────────────────┘                                    ║
║                                                                                        ║
╚════════════════════════════════════════════════════════════════════════════════════════╝
```

## 四、微服务架构图

```
╔════════════════════════════════════════════════════════════════════════════════════════╗
║                        Spring Boot 4.0 微服务架构                                       ║
╠════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                        ║
║                              ┌─────────────────┐                                       ║
║                              │     Client      │                                       ║
║                              │  (Web/Mobile)   │                                       ║
║                              └────────┬────────┘                                       ║
║                                       │                                                ║
║                                       ▼                                                ║
║                         ┌─────────────────────────┐                                   ║
║                         │      API Gateway        │                                   ║
║                         │   (Spring Cloud Gateway)│                                   ║
║                         └────────────┬────────────┘                                   ║
║                                      │                                                 ║
║           ┌──────────────────────────┼──────────────────────────┐                    ║
║           │                          │                          │                    ║
║           ▼                          ▼                          ▼                    ║
║  ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐              ║
║  │   User Service  │      │  Order Service  │      │Product Service  │              ║
║  │  Spring Boot 4  │      │  Spring Boot 4  │      │  Spring Boot 4  │              ║
║  │    + WebMVC     │      │   + WebFlux     │      │    + WebMVC     │              ║
║  └────────┬────────┘      └────────┬────────┘      └────────┬────────┘              ║
║           │                        │                        │                        ║
║           ▼                        ▼                        ▼                        ║
║  ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐              ║
║  │   PostgreSQL    │      │     MongoDB     │      │   PostgreSQL    │              ║
║  └─────────────────┘      └─────────────────┘      └─────────────────┘              ║
║                                                                                        ║
║                          消息总线 / 事件驱动                                           ║
║  ┌───────────────────────────────────────────────────────────────────────────────┐   ║
║  │                           Apache Kafka / RabbitMQ                              │   ║
║  │                        (spring-boot-starter-kafka)                             │   ║
║  └───────────────────────────────────────────────────────────────────────────────┘   ║
║                                                                                        ║
║                              可观测性基础设施                                          ║
║  ┌───────────────────────────────────────────────────────────────────────────────┐   ║
║  │   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐  │   ║
║  │   │  Prometheus  │   │    Grafana   │   │    Jaeger    │   │     Loki     │  │   ║
║  │   │   (Metrics)  │   │(Dashboards)  │   │   (Traces)   │   │    (Logs)    │  │   ║
║  │   └──────────────┘   └──────────────┘   └──────────────┘   └──────────────┘  │   ║
║  │                                                                               │   ║
║  │                    OpenTelemetry Collector (OTLP)                             │   ║
║  │                 (spring-boot-starter-opentelemetry)                           │   ║
║  └───────────────────────────────────────────────────────────────────────────────┘   ║
║                                                                                        ║
║                                服务发现与配置                                          ║
║  ┌───────────────────────────────────────────────────────────────────────────────┐   ║
║  │   ┌──────────────────────────┐   ┌──────────────────────────┐                │   ║
║  │   │   Service Discovery      │   │    Config Server         │                │   ║
║  │   │   (Eureka / Consul)      │   │   (Spring Cloud Config)  │                │   ║
║  │   └──────────────────────────┘   └──────────────────────────┘                │   ║
║  └───────────────────────────────────────────────────────────────────────────────┘   ║
║                                                                                        ║
╚════════════════════════════════════════════════════════════════════════════════════════╝
```

## 五、自动配置加载流程

```
╔════════════════════════════════════════════════════════════════════════════════════════╗
║                          自动配置加载流程                                              ║
╠════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                        ║
║   main() 方法启动                                                                      ║
║        │                                                                               ║
║        ▼                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────┐             ║
║   │              SpringApplication.run()                                 │             ║
║   └─────────────────────────────────────────────────────────────────────┘             ║
║        │                                                                               ║
║        ▼                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────┐             ║
║   │           创建 ApplicationContext                                    │             ║
║   └─────────────────────────────────────────────────────────────────────┘             ║
║        │                                                                               ║
║        ▼                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────┐             ║
║   │       扫描 META-INF/spring/org.springframework.boot.autoconfigure.  │             ║
║   │              AutoConfiguration.imports                               │             ║
║   │                                                                      │             ║
║   │   Spring Boot 4.0: 每个模块独立的 imports 文件                        │             ║
║   │                                                                      │             ║
║   │   ┌─────────────────────────────────────────────────────────────┐   │             ║
║   │   │  spring-boot-webmvc/                                        │   │             ║
║   │   │    └── META-INF/spring/*.AutoConfiguration.imports          │   │             ║
║   │   │  spring-boot-data-jpa/                                      │   │             ║
║   │   │    └── META-INF/spring/*.AutoConfiguration.imports          │   │             ║
║   │   │  spring-boot-security/                                      │   │             ║
║   │   │    └── META-INF/spring/*.AutoConfiguration.imports          │   │             ║
║   │   └─────────────────────────────────────────────────────────────┘   │             ║
║   └─────────────────────────────────────────────────────────────────────┘             ║
║        │                                                                               ║
║        ▼                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────┐             ║
║   │              处理 @Conditional 条件注解                              │             ║
║   │                                                                      │             ║
║   │   @ConditionalOnClass        类存在时生效                            │             ║
║   │   @ConditionalOnMissingBean  Bean不存在时生效                        │             ║
║   │   @ConditionalOnProperty     属性满足时生效                          │             ║
║   │   @ConditionalOnWebApplication  Web环境时生效                        │             ║
║   └─────────────────────────────────────────────────────────────────────┘             ║
║        │                                                                               ║
║        ▼                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────┐             ║
║   │              注册符合条件的 Bean                                     │             ║
║   └─────────────────────────────────────────────────────────────────────┘             ║
║        │                                                                               ║
║        ▼                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────┐             ║
║   │              应用就绪，开始处理请求                                   │             ║
║   └─────────────────────────────────────────────────────────────────────┘             ║
║                                                                                        ║
╚════════════════════════════════════════════════════════════════════════════════════════╝
```
